<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .title { font-size:1rem; color:#555; margin-bottom:5px; }
    .value { font-size:2rem; font-weight:bold; }
    canvas { width:100% !important; height:60px !important; }
  </style>
  <!-- Chart.js for sparklines -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card" id="total-workers-card">
      <div class="title">Total Workers</div>
      <div class="value" id="total-workers">-</div>
    </div>
    <div class="card" id="active-workers-card">
      <div class="title">Active Workers</div>
      <div class="value" id="active-workers">-</div>
    </div>
    <div class="card" id="throughput-card">
      <div class="title">Tasks / Minute</div>
      <canvas id="throughput-sparkline"></canvas>
    </div>
    <div class="card" id="cost-card">
      <div class="title">Estimated Cost / Hour</div>
      <div class="value" id="cost-per-hour">-</div>
    </div>
    <div class="card" id="error-rate-card">
      <div class="title">API Error Rate</div>
      <canvas id="error-rate-sparkline"></canvas>
    </div>
    <div class="card" id="checkpoint-card">
      <div class="title">Checkpoint Freshness (min)</div>
      <canvas id="checkpoint-sparkline"></canvas>
    </div>
  </div>

  <script>
    const pollingInterval = 5000; // ms

    // Buffers for sparklines (keep last N points)
    const MAX_POINTS = 30;
    const throughputData = [];
    const errorRateData = [];
    const checkpointData = [];

    // Chart instances
    let throughputChart, errorRateChart, checkpointChart;

    function initCharts() {
      const sparklineOpts = {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#3e95cd', fill: false, tension: 0.3 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { display: false }, y: { display: false, beginAtZero: true } },
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          elements: { point:{ radius:0 } }
        }
      };

      throughputChart = new Chart(document.getElementById('throughput-sparkline'), JSON.parse(JSON.stringify(sparklineOpts)));
      errorRateChart = new Chart(document.getElementById('error-rate-sparkline'), JSON.parse(JSON.stringify(sparklineOpts)));
      checkpointChart = new Chart(document.getElementById('checkpoint-sparkline'), JSON.parse(JSON.stringify(sparklineOpts)));
    }

    function updateChart(chart, buffer) {
      chart.data.labels = buffer.map((_, i) => i);
      chart.data.datasets[0].data = buffer;
      chart.update('none');
    }

    async function fetchStats() {
      try {
        const resp = await fetch('/api/stats');
        if (!resp.ok) throw new Error('Network response not ok');
        const stats = await resp.json();

        // Expected keys: total_workers, active_workers, tasks_per_minute, cost_per_hour,
        // api_error_rate (0-1), checkpoint_freshness_minutes
        document.getElementById('total-workers').textContent = stats.total_workers ?? '-';
        document.getElementById('active-workers').textContent = stats.active_workers ?? '-';
        document.getElementById('cost-per-hour').textContent = stats.cost_per_hour ? `$${stats.cost_per_hour.toFixed(2)}` : '-';

        // Update buffers
        if (stats.tasks_per_minute !== undefined) {
          throughputData.push(stats.tasks_per_minute);
          if (throughputData.length > MAX_POINTS) throughputData.shift();
          updateChart(throughputChart, throughputData);
        }

        if (stats.api_error_rate !== undefined) {
          const percent = stats.api_error_rate * 100;
          errorRateData.push(percent);
          if (errorRateData.length > MAX_POINTS) errorRateData.shift();
          updateChart(errorRateChart, errorRateData);
        }

        if (stats.checkpoint_freshness_minutes !== undefined) {
          checkpointData.push(stats.checkpoint_freshness_minutes);
          if (checkpointData.length > MAX_POINTS) checkpointData.shift();
          updateChart(checkpointChart, checkpointData);
        }
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Init
    initCharts();
    fetchStats();
    setInterval(fetchStats, pollingInterval);
  </script>
</body>
</html>