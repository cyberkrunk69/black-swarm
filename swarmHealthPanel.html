<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 15px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); }
    .title { font-weight: bold; margin-bottom: 5px; }
    .value { font-size: 1.8em; }
    .gauge { width: 100%; height: 150px; }
    .sparkline { width: 100%; height: 80px; }
  </style>
  <!-- Chart.js for sparklines -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card">
      <div class="title">Total Workers</div>
      <div id="totalWorkers" class="value">–</div>
    </div>
    <div class="card">
      <div class="title">Active Workers</div>
      <div id="activeWorkers" class="value">–</div>
    </div>
    <div class="card">
      <div class="title">Tasks / Minute</div>
      <canvas id="tasksSparkline" class="sparkline"></canvas>
    </div>
    <div class="card">
      <div class="title">Estimated Cost / Hour</div>
      <div id="costPerHour" class="value">–</div>
    </div>
    <div class="card">
      <div class="title">API Error Rate</div>
      <canvas id="errorRateGauge" class="gauge"></canvas>
    </div>
    <div class="card">
      <div class="title">Checkpoint Freshness (s)</div>
      <canvas id="checkpointGauge" class="gauge"></canvas>
    </div>
  </div>

  <script>
    // Configuration
    const POLL_INTERVAL_MS = 5000; // 5 seconds
    const statsUrl = '/api/stats';

    // State for sparklines
    const tasksHistory = [];
    const MAX_HISTORY = 30; // keep last 30 points (~2.5 min)

    // Initialize charts
    const tasksCtx = document.getElementById('tasksSparkline').getContext('2d');
    const tasksChart = new Chart(tasksCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Tasks/min',
          data: [],
          borderColor: '#3e95cd',
          fill: false,
          tension: 0.2,
          pointRadius: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { display: false },
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Helper to draw a simple gauge using Chart.js doughnut
    function createGauge(ctx, value, max, color) {
      const gaugeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [value, max - value],
            backgroundColor: [color, '#e0e0e0'],
            borderWidth: 0,
            cutout: '80%'
          }]
        },
        options: {
          rotation: -90,
          circumference: 180,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { enabled: false },
            legend: { display: false },
            // Show value in the middle
            beforeDraw: function(chart) {
              const {ctx, width, height} = chart;
              ctx.save();
              ctx.font = 'bold 16px Arial';
              ctx.fillStyle = '#000';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              const text = `${value}${max===100?'%':''}`;
              ctx.fillText(text, width / 2, height / 1.2);
            }
          }
        }
      });
      return gaugeChart;
    }

    let errorGauge = null;
    let checkpointGauge = null;

    async function fetchStats() {
      try {
        const resp = await fetch(statsUrl);
        if (!resp.ok) throw new Error('Network response was not ok');
        const data = await resp.json();

        // Expected data shape:
        // {
        //   total_workers: number,
        //   active_workers: number,
        //   tasks_per_minute: number,
        //   estimated_cost_per_hour: number,
        //   api_error_rate: number (0-1),
        //   checkpoint_freshness_seconds: number
        // }

        document.getElementById('totalWorkers').textContent = data.total_workers ?? '–';
        document.getElementById('activeWorkers').textContent = data.active_workers ?? '–';
        document.getElementById('costPerHour').textContent = data.estimated_cost_per_hour != null
          ? `$${data.estimated_cost_per_hour.toFixed(2)}`
          : '–';

        // Update tasks sparkline
        const tpm = data.tasks_per_minute ?? 0;
        if (tasksHistory.length >= MAX_HISTORY) {
          tasksHistory.shift();
          tasksChart.data.labels.shift();
        }
        tasksHistory.push(tpm);
        tasksChart.data.labels.push(''); // empty label for spacing
        tasksChart.data.datasets[0].data = tasksHistory;
        tasksChart.update('none');

        // Update error rate gauge
        const errorRate = (data.api_error_rate ?? 0) * 100; // percent
        if (errorGauge) errorGauge.destroy();
        const errCtx = document.getElementById('errorRateGauge').getContext('2d');
        errorGauge = createGauge(errCtx, errorRate, 100, '#ff6384');

        // Update checkpoint freshness gauge (max 300 seconds = 5 mins)
        const freshness = data.checkpoint_freshness_seconds ?? 0;
        const freshnessMax = 300;
        const freshnessVal = Math.min(freshness, freshnessMax);
        if (checkpointGauge) checkpointGauge.destroy();
        const cpCtx = document.getElementById('checkpointGauge').getContext('2d');
        checkpointGauge = createGauge(cpCtx, freshnessVal, freshnessMax, '#36a2eb');

      } catch (err) {
        console.error('Failed to fetch stats:', err);
      }
    }

    // Initial fetch + polling
    fetchStats();
    setInterval(fetchStats, POLL_INTERVAL_MS);
  </script>
</body>
</html>