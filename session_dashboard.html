<!-- session_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LAN Session Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>LAN Session Dashboard</h1>
    <table id="sessions-table">
        <thead>
            <tr>
                <th>IP Address</th>
                <th>Created At</th>
                <th>Your Tasks</th>
                <th>Network Activity</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be injected by JavaScript -->
        </tbody>
    </table>

    <script>
        const ws = new WebSocket("ws://localhost:8765");

        ws.onopen = () => console.log("WebSocket connected");
        ws.onclose = () => console.log("WebSocket closed");
        ws.onerror = err => console.error("WebSocket error:", err);

        // Simple protocol: server sends a JSON string with the full session dict
        ws.onmessage = event => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === "sessions_snapshot") {
                    renderSessions(data.sessions);
                }
            } catch (e) {
                console.warn("Nonâ€‘JSON WS message:", event.data);
            }
        };

        function renderSessions(sessions) {
            const tbody = document.querySelector("#sessions-table tbody");
            tbody.innerHTML = "";   // clear existing rows

            Object.entries(sessions).forEach(([ip, sess]) => {
                const tr = document.createElement("tr");

                const created = new Date(sess.created_at * 1000).toLocaleString();

                tr.innerHTML = `
                    <td>${ip}</td>
                    <td>${created}</td>
                    <td>${sess.tasks.join(", ")}</td>
                    <td>${sess.network_activity.join(", ")}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Request an initial snapshot after connection
        ws.addEventListener("open", () => ws.send(JSON.stringify({action: "snapshot"})));
    </script>
</body>
</html>