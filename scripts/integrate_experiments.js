/**
 * Self-Integration Pipeline
 *
 * This script automates the validation and merging of changes made in the
 * `experiments/` directory into the main codebase. It performs the following steps:
 *
 * 1. Detects any modified or new files under `experiments/`.
 * 2. Runs linting and unit tests to ensure code quality.
 * 3. Creates a dedicated feature branch for the changes.
 * 4. Commits the changes with a conventional commit message.
 * 5. Opens a pull request against `main` (requires GitHub CLI `gh`).
 * 6. If the CI checks pass, the PR is merged automatically.
 *
 * Prerequisites:
 *   - Node.js >=14
 *   - Git CLI installed and configured with appropriate credentials.
 *   - GitHub CLI (`gh`) installed and authenticated.
 *
 * Usage:
 *   node scripts/integrate_experiments.js
 */

const { execSync, spawnSync } = require('child_process');
const path = require('path');
const fs = require('fs');

function runCommand(command, options = {}) {
    try {
        const result = execSync(command, { stdio: 'pipe', encoding: 'utf-8', ...options });
        return result.trim();
    } catch (err) {
        console.error(`Command failed: ${command}`);
        console.error(err.stdout);
        console.error(err.stderr);
        process.exit(1);
    }
}

// Step 1: Detect changes in experiments/
function getExperimentChanges() {
    const status = runCommand('git status --porcelain');
    const lines = status.split('\n').filter(Boolean);
    const expChanges = lines.filter(line => line.includes('experiments/')).map(line => line.slice(3));
    return expChanges;
}

// Step 2: Lint and test
function lintAndTest() {
    console.log('Running lint...');
    runCommand('npm run lint');
    console.log('Running tests...');
    runCommand('npm test');
}

// Step 3: Create feature branch
function createFeatureBranch() {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const branchName = `integrate/experiments-${timestamp}`;
    runCommand(`git checkout -b ${branchName}`);
    return branchName;
}

// Step 4: Commit changes
function commitChanges() {
    runCommand('git add experiments/');
    const msg = 'feat(experiments): integrate experimental changes';
    runCommand(`git commit -m "${msg}"`);
}

// Step 5: Open PR using GitHub CLI
function openPullRequest(branch) {
    const title = 'Integrate experiments into mainline';
    const body = 'Automated PR generated by integrate_experiments.js. Includes validated experimental changes.';
    runCommand(`gh pr create --title "${title}" --body "${body}" --head ${branch} --base main`);
}

// Step 6: Merge PR if checks pass
function mergeIfGreen() {
    // Retrieve the PR number of the current branch
    const prUrl = runCommand('gh pr view --json number,url -q ".url"');
    console.log(`Waiting for CI checks to pass on PR: ${prUrl}`);
    // Poll until checks are successful
    const maxAttempts = 30;
    const intervalMs = 20000; // 20 seconds
    for (let i = 0; i < maxAttempts; i++) {
        const status = runCommand(`gh pr checks ${prUrl} --json status -q ".status"`);
        if (status === 'PASSING') {
            console.log('All checks passed. Merging PR...');
            runCommand(`gh pr merge ${prUrl} --auto --merge`);
            return;
        }
        console.log(`Checks not passed yet (${i + 1}/${maxAttempts}). Waiting...`);
        execSync(`sleep ${intervalMs / 1000}`);
    }
    console.error('CI checks did not pass within the expected time. Manual intervention required.');
    process.exit(1);
}

// Main execution flow
function main() {
    const changes = getExperimentChanges();
    if (changes.length === 0) {
        console.log('No changes detected in experiments/. Exiting.');
        return;
    }
    console.log('Detected experiment changes:', changes);
    lintAndTest();
    const branch = createFeatureBranch();
    commitChanges();
    openPullRequest(branch);
    mergeIfGreen();
    console.log('Integration pipeline completed successfully.');
}

main();
/**
 * integrate_experiments.js
 *
 * This script automates the safe integration of any changes made inside the
 * `experiments/` directory into the main code‚Äëbase.
 *
 * Workflow:
 *   1. Detect modified/added files under `experiments/`.
 *   2. Copy them to their target locations (mirroring the relative path under `src/`).
 *   3. Run the project's test suite (`npm test`).
 *   4. If tests pass, stage, commit and push the changes on a dedicated branch.
 *   5. Open a pull request (requires `gh` CLI) for human review.
 *
 * The script is deliberately defensive:
 *   - It aborts on any git conflict.
 *   - It never overwrites files that already exist in `src/` without user confirmation.
 *   - All operations are logged to the console.
 */

const fs = require('fs');
const path = require('path');
const { execSync, spawnSync } = require('child_process');
const simpleGit = require('simple-git');
const git = simpleGit();

const EXPERIMENTS_DIR = path.resolve(__dirname, '..', 'experiments');
const SRC_DIR = path.resolve(__dirname, '..', 'src');
const INTEGRATION_BRANCH_PREFIX = 'integrate/experiments-';

async function main() {
    try {
        // 1Ô∏è‚É£ Ensure we are on a clean working tree
        const status = await git.status();
        if (status.files.length) {
            console.error('‚ùå Working tree not clean. Please commit or stash changes before running the integration script.');
            process.exit(1);
        }

        // 2Ô∏è‚É£ Find changed files inside experiments/
        const diff = await git.diff(['--name-only', 'HEAD']);
        const changedFiles = diff
            .split('\n')
            .filter(f => f.startsWith('experiments/') && f.trim() !== '');

        if (changedFiles.length === 0) {
            console.log('‚úÖ No changes detected in the experiments/ folder.');
            return;
        }

        console.log('üîé Detected experiment changes:');
        changedFiles.forEach(f => console.log('  -', f));

        // 3Ô∏è‚É£ Create a temporary branch for the integration
        const branchName = INTEGRATION_BRANCH_PREFIX + Date.now();
        await git.checkoutLocalBranch(branchName);
        console.log(`üåø Created integration branch ${branchName}`);

        // 4Ô∏è‚É£ Copy files to src/ preserving relative paths
        for (const relPath of changedFiles) {
            const srcPath = path.resolve(__dirname, '..', relPath);
            const targetRel = path.relative('experiments', relPath);
            const targetPath = path.join(SRC_DIR, targetRel);

            // Ensure target directory exists
            fs.mkdirSync(path.dirname(targetPath), { recursive: true });

            // If target already exists, ask for confirmation
            if (fs.existsSync(targetPath)) {
                const answer = spawnSync('cmd', ['/c', 'choice', '/c', 'YN', '/n', '/m', `File ${targetRel} already exists. Overwrite? (Y/N)`], { stdio: 'inherit' });
                if (answer.status !== 0) {
                    console.log(`‚è≠Ô∏è Skipping ${targetRel}`);
                    continue;
                }
            }

            fs.copyFileSync(srcPath, targetPath);
            console.log(`üìÑ Copied ${relPath} ‚Üí src/${targetRel}`);
        }

        // 5Ô∏è‚É£ Run test suite
        console.log('üß™ Running test suite...');
        try {
            execSync('npm test', { stdio: 'inherit' });
        } catch (e) {
            console.error('‚ùå Tests failed. Aborting integration.');
            await git.checkout('main');
            await git.branch(['-D', branchName]);
            process.exit(1);
        }

        // 6Ô∏è‚É£ Commit and push
        await git.add('.');
        await git.commit('chore: integrate experiments changes');
        await git.push('origin', branchName);
        console.log(`üöÄ Pushed integration branch ${branchName}`);

        // 7Ô∏è‚É£ Open PR (requires GitHub CLI)
        try {
            execSync(`gh pr create --title "Integrate experiments changes" --body "Auto‚Äëgenerated integration from experiments folder." --base main --head ${branchName}`, { stdio: 'inherit' });
            console.log('üîó Pull request created.');
        } catch (e) {
            console.warn('‚ö†Ô∏è GitHub CLI not configured or PR creation failed. Push the branch manually.');
        }

        // Return to main
        await git.checkout('main');
    } catch (err) {
        console.error('‚ùó Unexpected error:', err);
        process.exit(1);
    }
}

main();