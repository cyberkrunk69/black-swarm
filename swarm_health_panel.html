<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swarm Health Panel</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
  .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
  .card { background:#fff; border-radius:8px; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .card h3 { margin-top:0; font-size:1rem; color:#555; }
  canvas { max-width:100%; }
  .sparkline { height:50px; }
</style>
</head>
<body>
<h1>Swarm Health Panel</h1>
<div class="grid">
  <div class="card">
    <h3>Total Workers</h3>
    <canvas id="totalWorkersGauge"></canvas>
  </div>
  <div class="card">
    <h3>Active Workers</h3>
    <canvas id="activeWorkersGauge"></canvas>
  </div>
  <div class="card">
    <h3>Tasks / Minute</h3>
    <canvas id="tasksPerMinuteGauge"></canvas>
  </div>
  <div class="card">
    <h3>Estimated Cost / Hour ($)</h3>
    <canvas id="costPerHourGauge"></canvas>
  </div>
  <div class="card">
    <h3>API Error Rate (%)</h3>
    <canvas id="apiErrorRateGauge"></canvas>
  </div>
  <div class="card">
    <h3>Checkpoint Freshness (seconds ago)</h3>
    <canvas id="checkpointSparkline" class="sparkline"></canvas>
  </div>
</div>

<script>
const pollInterval = 5000; // ms

// Helper to create a gauge (doughnut) chart
function createGauge(ctx, label, max) {
  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: [label, ''],
      datasets: [{
        data: [0, max],
        backgroundColor: ['#4caf50', '#e0e0e0'],
        borderWidth: 0,
        cutout: '80%'
      }]
    },
    options: {
      rotation: -90,
      circumference: 180,
      plugins: {
        tooltip: { enabled: false },
        legend: { display: false },
        title: {
          display: true,
          text: label,
          font: { size: 14 }
        }
      }
    }
  });
}

// Sparkline for checkpoint freshness
function createSparkline(ctx) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        data: [],
        borderColor: '#2196f3',
        backgroundColor: 'rgba(33,150,243,0.2)',
        fill: true,
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      animation: false,
      scales: {
        x: { display: false },
        y: { display: false, suggestedMin: 0 }
      },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: false }
      }
    }
  });
}

// Initialize charts
const gauges = {
  totalWorkers: createGauge(document.getElementById('totalWorkersGauge').getContext('2d'), 'Workers', 100),
  activeWorkers: createGauge(document.getElementById('activeWorkersGauge').getContext('2d'), 'Active', 100),
  tasksPerMinute: createGauge(document.getElementById('tasksPerMinuteGauge').getContext('2d'), 'TPM', 200),
  costPerHour: createGauge(document.getElementById('costPerHourGauge').getContext('2d'), 'Cost/hr', 100),
  apiErrorRate: createGauge(document.getElementById('apiErrorRateGauge').getContext('2d'), 'Error %', 100)
};

const checkpointChart = createSparkline(document.getElementById('checkpointSparkline').getContext('2d'));

// Update function
async function fetchStats() {
  try {
    const resp = await fetch('/api/stats');
    if (!resp.ok) throw new Error('Network response was not ok');
    const data = await resp.json();

    // Expected keys: total_workers, active_workers, tasks_per_minute,
    // estimated_cost_per_hour, api_error_rate, checkpoint_freshness_seconds

    function updateGauge(gauge, value, max) {
      gauge.data.datasets[0].data = [value, Math.max(max - value, 0)];
      gauge.update();
    }

    updateGauge(gauges.totalWorkers, data.total_workers, 100);
    updateGauge(gauges.activeWorkers, data.active_workers, data.total_workers || 100);
    updateGauge(gauges.tasksPerMinute, data.tasks_per_minute, 200);
    updateGauge(gauges.costPerHour, data.estimated_cost_per_hour, 100);
    updateGauge(gauges.apiErrorRate, data.api_error_rate, 100);

    // Sparkline handling
    const now = new Date();
    checkpointChart.data.labels.push(now);
    checkpointChart.data.datasets[0].data.push(data.checkpoint_freshness_seconds);
    if (checkpointChart.data.labels.length > 30) {
      checkpointChart.data.labels.shift();
      checkpointChart.data.datasets[0].data.shift();
    }
    checkpointChart.update();
  } catch (e) {
    console.error('Failed to fetch stats:', e);
  }
}

// Initial fetch and start polling
fetchStats();
setInterval(fetchStats, pollInterval);
</script>
</body>
</html>