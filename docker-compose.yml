services:
  # Dashboard UI - always running
  dashboard:
    build: .
    container_name: vivarium-ui
    command: python dashboard_server.py
    ports:
      - "8420:8420"
    environment:
      - WORKSPACE=/app
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - .:/app
      - ./vivarium/world/mutable:/app/vivarium/world/mutable:rw
      - ./vivarium/meta:/app/vivarium/meta:rw
    networks:
      - swarm-net
    restart: unless-stopped

  # Worker swarm - runs tasks (HARDENED)
  swarm:
    build: .
    container_name: vivarium
    command: python grind_spawner_unified.py --delegate --budget 1.00
    environment:
      - INFERENCE_ENGINE=${INFERENCE_ENGINE:-groq}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - WORKSPACE=/app
    volumes:
      # Read-only mounts for code
      - ./grind_spawner_unified.py:/app/grind_spawner_unified.py:ro
      - ./inference_engine.py:/app/inference_engine.py:ro
      - ./groq_client.py:/app/groq_client.py:ro
      - ./safety_sandbox.py:/app/safety_sandbox.py:ro
      - ./safety_gateway.py:/app/safety_gateway.py:ro
      - ./safety_sanitize.py:/app/safety_sanitize.py:ro
      - ./safety_killswitch.py:/app/safety_killswitch.py:ro
      - ./safety_constitutional.py:/app/safety_constitutional.py:ro
      - ./vivarium_scope.py:/app/vivarium_scope.py:ro
      # Writable mounts for AI to work in
      - ./vivarium/world/mutable:/app/vivarium/world/mutable:rw
      - ./vivarium/meta:/app/vivarium/meta:rw
      # Read-only knowledge base
      - ../stripper/knowledge:/app/knowledge:ro
    networks:
      - swarm-net
    # Security hardening
    cap_drop:
      - ALL  # Drop all capabilities
    cap_add:
      - NET_ADMIN  # Only add back what's needed for network lockdown
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
      - seccomp:unconfined  # TODO: Create custom seccomp profile
    read_only: false  # Can't use read_only with Python (needs /tmp)
    tmpfs:
      - /tmp:size=100M,mode=1777  # Temp filesystem in memory only
      - /var/tmp:size=50M,mode=1777
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Network isolation
    dns:
      - 8.8.8.8  # Explicit DNS (though network lockdown limits it)
    depends_on:
      - dashboard
    restart: unless-stopped

networks:
  swarm-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
