services:
  # API server (FastAPI) – bound to localhost on the host for safety.
  api:
    build: .
    container_name: black-swarm-api
    command: python -m uvicorn swarm:app --host 0.0.0.0 --port 8420
    ports:
      - "127.0.0.1:8420:8420"
    environment:
      - WORKSPACE=/app
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - ./data:/app/data:rw
      - ./grind_logs:/app/grind_logs:rw
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=100M,mode=1777

  # Control panel UI (Flask + SocketIO) – bound to localhost on the host for safety.
  control-panel:
    build: .
    container_name: black-swarm-control-panel
    command: python control_panel.py
    ports:
      - "127.0.0.1:8421:8421"
    environment:
      - WORKSPACE=/app
      # Inside containers we bind to 0.0.0.0, but compose maps ports to 127.0.0.1 only.
      - SWARM_CONTROL_PANEL_HOST=0.0.0.0
      - SWARM_CONTROL_PANEL_PORT=8421
      - SWARM_CONTROL_PANEL_DEBUG=0
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - ./grind_logs:/app/grind_logs:rw
      - ./queue.json:/app/queue.json:rw
      - ./tool_operations.json:/app/tool_operations.json:rw
    depends_on:
      - api
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    tmpfs:
      - /tmp:size=100M,mode=1777

networks:
  default:
    name: swarm-net
