name: Lint & Type Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Determine changed Python files
        id: changed_py
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            DIFF_RANGE="${{ github.event.pull_request.base.sha }}...${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BEFORE_SHA="${{ github.event.before }}"
            if [[ -n "$BEFORE_SHA" && "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]]; then
              DIFF_RANGE="${BEFORE_SHA}...${{ github.sha }}"
            else
              DIFF_RANGE="${{ github.sha }}~1...${{ github.sha }}"
            fi
          else
            DIFF_RANGE="${{ github.sha }}~1...${{ github.sha }}"
          fi

          mapfile -t PY_FILES < <(git diff --name-only --diff-filter=ACMRT "$DIFF_RANGE" -- "*.py")
          if (( ${#PY_FILES[@]} == 0 )); then
            echo "has_python_changes=false" >> "$GITHUB_OUTPUT"
            echo "No Python file changes detected."
            exit 0
          fi

          printf '%s\n' "${PY_FILES[@]}" > changed-python.txt
          echo "has_python_changes=true" >> "$GITHUB_OUTPUT"
          echo "Changed Python files:"
          cat changed-python.txt

      - name: Run Black (check mode) on changed files
        if: steps.changed_py.outputs.has_python_changes == 'true'
        run: black --check $(tr '\n' ' ' < changed-python.txt)

      - name: Run Flake8 on changed files
        if: steps.changed_py.outputs.has_python_changes == 'true'
        run: flake8 --max-line-length=88 --extend-ignore=E203,W503 $(tr '\n' ' ' < changed-python.txt)

      # Enforce typing discipline incrementally to avoid blocking on legacy debt.
      - name: Run MyPy on changed files
        if: steps.changed_py.outputs.has_python_changes == 'true'
        run: mypy $(tr '\n' ' ' < changed-python.txt)