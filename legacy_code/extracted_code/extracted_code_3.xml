<patch path="dashboard_vision.js" action="insert_after" line="/* End of UI initialization */">
/* -------------------------------------------------
   Real‑time Worker Grid – SSE implementation
   ------------------------------------------------- */
const workersState = new Map();   // key: workerId, value: {status, startTime, action}

/* Helper: convert status to a colour */
function statusColor(status) {
    switch (status.toLowerCase()) {
        case 'running':   return '#28a745';   // green
        case 'idle':      return '#6c757d';   // gray
        case 'error':     return '#dc3545';   // red
        case 'paused':    return '#ffc107';   // yellow
        default:          return '#007bff';   // blue
    }
}

/* Render the whole grid – called after any state change */
function renderWorkerGrid() {
    // clear previous content
    workerGridContainer.innerHTML = '';

    workersState.forEach((info, id) => {
        const elapsedSec = Math.floor((Date.now() - info.startTime) / 1000);
        const cell = document.createElement('div');
        cell.className = 'worker-cell';
        cell.innerHTML = `
            <div><strong>ID:</strong> ${id}</div>
            <div><strong>Status:</strong> <span class="status" style="color:${statusColor(info.status)};">${info.status}</span></div>
            <div><strong>Elapsed:</strong> ${elapsedSec}s</div>
            <div><strong>Action:</strong> ${info.action || '—'}</div>
        `;
        workerGridContainer.appendChild(cell);
    });
}

/* SSE connection – assumes the backend exposes /api/worker-updates */
const workerEventSource = new EventSource('/api/worker-updates');

workerEventSource.onmessage = (event) => {
    try {
        const payload = JSON.parse(event.data);
        // Expected payload shape: { workerId, status, action, timestamp }
        const { workerId, status, action, timestamp } = payload;

        // If we already have the worker, keep the original startTime; otherwise set now.
        const existing = workersState.get(workerId);
        const startTime = existing ? existing.startTime : (timestamp ? new Date(timestamp).getTime() : Date.now());

        workersState.set(workerId, {
            status,
            action,
            startTime,
        });

        renderWorkerGrid();
    } catch (e) {
        console.error('Failed to process worker update:', e);
    }
};

workerEventSource.onerror = (err) => {
    console.error('Worker SSE connection error:', err);
    // Optional: attempt reconnection after a delay
};
</patch>