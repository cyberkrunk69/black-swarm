<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .card { background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .title { font-size:1rem; color:#555; margin-bottom:5px; }
    .value { font-size:1.5rem; font-weight:bold; }
    canvas { width:100% !important; height:auto !important; }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card" id="total-workers-card">
      <div class="title">Total Workers</div>
      <div class="value" id="total-workers">-</div>
    </div>
    <div class="card" id="active-workers-card">
      <div class="title">Active Workers</div>
      <div class="value" id="active-workers">-</div>
    </div>
    <div class="card" id="throughput-card">
      <div class="title">Tasks / Minute</div>
      <canvas id="throughput-gauge"></canvas>
    </div>
    <div class="card" id="cost-card">
      <div class="title">Estimated Cost / Hour</div>
      <canvas id="cost-gauge"></canvas>
    </div>
    <div class="card" id="error-rate-card">
      <div class="title">API Error Rate</div>
      <canvas id="error-rate-gauge"></canvas>
    </div>
    <div class="card" id="checkpoint-card">
      <div class="title">Checkpoint Freshness (min)</div>
      <canvas id="checkpoint-sparkline"></canvas>
    </div>
  </div>

  <script>
    // Helper to create a simple gauge using Chart.js doughnut
    function createGauge(ctx, label, max) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [0, max],
            backgroundColor: ['#4caf50', '#e0e0e0'],
            borderWidth: 0,
          }],
          labels: [label, '']
        },
        options: {
          rotation: -Math.PI,
          circumference: Math.PI,
          cutout: '80%',
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: { display: false }
          }
        }
      });
    }

    // Sparkline for checkpoint freshness
    function createSparkline(ctx) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderColor: '#2196f3',
            fill: false,
            tension: 0.3,
            pointRadius: 0
          }]
        },
        options: {
          animation: false,
          scales: {
            x: { display: false },
            y: { display: false, min: 0 }
          },
          plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
      });
    }

    const gaugeConfigs = {
      throughput: { ctx: document.getElementById('throughput-gauge').getContext('2d'), max: 500 },
      cost: { ctx: document.getElementById('cost-gauge').getContext('2d'), max: 100 },
      errorRate: { ctx: document.getElementById('error-rate-gauge').getContext('2d'), max: 100 }
    };

    const gauges = {
      throughput: createGauge(gaugeConfigs.throughput.ctx, 'Tasks/min', gaugeConfigs.throughput.max),
      cost: createGauge(gaugeConfigs.cost.ctx, '$/hr', gaugeConfigs.cost.max),
      errorRate: createGauge(gaugeConfigs.errorRate.ctx, '%', gaugeConfigs.errorRate.max)
    };

    const sparkline = createSparkline(document.getElementById('checkpoint-sparkline').getContext('2d'));

    async function fetchStats() {
      try {
        const res = await fetch('/api/stats');
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();

        // Update simple values
        document.getElementById('total-workers').textContent = data.total_workers ?? '-';
        document.getElementById('active-workers').textContent = data.active_workers ?? '-';

        // Update gauges
        const updateGauge = (g, value, max) => {
          g.data.datasets[0].data[0] = Math.min(value, max);
          g.data.datasets[0].data[1] = Math.max(max - value, 0);
          g.update();
        };
        updateGauge(gauges.throughput, data.tasks_per_minute ?? 0, gaugeConfigs.throughput.max);
        updateGauge(gauges.cost, data.estimated_cost_per_hour ?? 0, gaugeConfigs.cost.max);
        updateGauge(gauges.errorRate, (data.api_error_rate_percent ?? 0), gaugeConfigs.errorRate.max);

        // Update sparkline (keep last 30 points)
        const now = new Date().toLocaleTimeString();
        sparkline.data.labels.push(now);
        sparkline.data.datasets[0].data.push(data.checkpoint_freshness_minutes ?? 0);
        if (sparkline.data.labels.length > 30) {
          sparkline.data.labels.shift();
          sparkline.data.datasets[0].data.shift();
        }
        sparkline.update();
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Poll every 5 seconds
    fetchStats();
    setInterval(fetchStats, 5000);
  </script>
</body>
</html>