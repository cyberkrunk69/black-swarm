<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Dependency Graph</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .node rect {
            stroke-width: 2px;
            fill: #fff;
        }
        .node.completed rect {
            fill: #8fdb8f; /* green */
        }
        .node.inprogress rect {
            fill: #fff;
            stroke: url(#rainbow);
        }
        .node.blocked rect {
            fill: #d3d3d3; /* gray */
        }
        .edgePath path {
            stroke: #333;
            stroke-width: 1.5px;
            fill: none;
        }
        .edgeLabel {
            font-size: 10px;
        }
        /* Rainbow border definition */
        #rainbow {
            stroke: url(#rainbowGradient);
        }
        svg defs linearGradient#rainbowGradient stop:nth-child(1) { stop-color:#ff0000; }
        svg defs linearGradient#rainbowGradient stop:nth-child(2) { stop-color:#ff7f00; }
        svg defs linearGradient#rainbowGradient stop:nth-child(3) { stop-color:#ffff00; }
        svg defs linearGradient#rainbowGradient stop:nth-child(4) { stop-color:#00ff00; }
        svg defs linearGradient#rainbowGradient stop:nth-child(5) { stop-color:#0000ff; }
        svg defs linearGradient#rainbowGradient stop:nth-child(6) { stop-color:#8b00ff; }
    </style>
</head>
<body>
    <h1>Task Dependency Graph</h1>
    <svg id="svg-canvas" width="960" height="600"></svg>

    <!-- D3.js and Dagre-D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>

    <script>
        // List of JSON files to load – adjust as needed
        const jsonFiles = [
            // Example entries – replace with actual filenames present in the workspace
            "grind_tasks_phase1.json",
            "grind_tasks_phase2.json",
            "grind_tasks_phase3.json"
        ];

        // Utility to fetch and parse all JSON files
        async function loadAllTasks() {
            const tasks = [];
            for (const file of jsonFiles) {
                try {
                    const resp = await fetch(`../${file}`);
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    tasks.push(...data);
                } catch (e) {
                    console.warn(`Failed to load ${file}:`, e);
                }
            }
            return tasks;
        }

        // Build DAG from tasks
        function buildGraph(tasks) {
            const g = new dagreD3.graphlib.Graph({ multigraph: true })
                .setGraph({})
                .setDefaultEdgeLabel(() => ({}));

            // Add nodes
            tasks.forEach(task => {
                const statusClass = task.status === "completed"
                    ? "completed"
                    : task.status === "in-progress"
                        ? "inprogress"
                        : "blocked";

                const label = `${task.id}\\n${task.phase || ''}`;
                g.setNode(task.id, {
                    label: label,
                    class: `node ${statusClass}`,
                    rx: 5,
                    ry: 5
                });
            });

            // Add edges based on dependencies
            tasks.forEach(task => {
                if (Array.isArray(task.dependencies)) {
                    task.dependencies.forEach(dep => {
                        if (g.hasNode(dep) && g.hasNode(task.id)) {
                            g.setEdge(dep, task.id);
                        }
                    });
                }
            });

            return g;
        }

        // Render graph into SVG
        function render(g) {
            const svg = d3.select("#svg-canvas");
            const inner = svg.append("g");

            // Define rainbow gradient for in‑progress border
            const defs = svg.append("defs");
            const grad = defs.append("linearGradient")
                .attr("id", "rainbowGradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "0%");
            const colors = ["#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#0000ff", "#8b00ff"];
            colors.forEach((c, i) => {
                grad.append("stop")
                    .attr("offset", `${(i / (colors.length - 1)) * 100}%`)
                    .attr("stop-color", c);
            });

            // Create the renderer
            const render = new dagreD3.render();

            // Run the renderer. This is what draws the final graph.
            render(inner, g);

            // Center the graph
            const xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
            inner.attr("transform", `translate(${xCenterOffset}, 20)`);
            svg.attr("height", g.graph().height + 40);
        }

        // Main
        (async () => {
            const tasks = await loadAllTasks();

            // Expect each JSON file to contain an array of task objects:
            // {
            //   "id": "task_1",
            //   "phase": "phase1",
            //   "status": "completed" | "in-progress" | "blocked",
            //   "dependencies": ["task_0", ...]
            // }
            const graph = buildGraph(tasks);
            render(graph);
        })();
    </script>
</body>
</html>