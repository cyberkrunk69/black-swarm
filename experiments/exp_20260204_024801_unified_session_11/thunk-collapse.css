/* ------------------------------------------------------------
 * Thunk Collapse Animation
 * ------------------------------------------------------------
 * Deepest nodes collapse first (LIFO) with an 80ms stagger.
 * Nodes shrink and translate toward the collapse point while
 * connection lines retract simultaneously.
 *
 * The base delay is exposed via the CSS custom property
 *   --thunk-delay (default: 80ms)
 *
 * Usage:
 *   <svg class="thunk-graph" style="--thunk-delay:80ms">
 *     <g class="thunk-node" data-depth="3">...</g>
 *     <line class="thunk-connection" data-depth="3" .../>
 *     ...
 *   </svg>
 *
 * The animation is applied by adding the class `thunk-collapsing`
 * to the root container.
 * ------------------------------------------------------------ */

.thunk-graph.thunk-collapsing .thunk-node,
.thunk-graph.thunk-collapsing .thunk-connection {
  animation-name: thunk-collapse;
  animation-duration: 300ms;
  animation-fill-mode: forwards;
  animation-timing-function: ease-in-out;
}

/* Stagger based on depth – deeper nodes have larger data-depth
 * values and therefore start earlier (LIFO). */
.thunk-graph.thunk-collapsing .thunk-node[data-depth],
.thunk-graph.thunk-collapsing .thunk-connection[data-depth] {
  animation-delay: calc(
    var(--thunk-delay, 80ms) *
    (var(--max-depth, 0) - attr(data-depth number) + 1)
  );
}

/* Fallback for browsers that don't support attr() in calc() */
.thunk-graph.thunk-collapsing .thunk-node[data-depth="0"],
.thunk-graph.thunk-collapsing .thunk-connection[data-depth="0"] {
  animation-delay: calc(var(--thunk-delay, 80ms) * var(--max-depth, 0));
}

/* -----------------------------------------------------------------
 * Keyframes
 * -----------------------------------------------------------------
 *   0%   – original size & position
 * 100%   – shrunk to 0 scale and moved to the collapse point
 *          (the collapse point is defined by CSS variables
 *           --collapse-x and --collapse-y on the root container)
 * ----------------------------------------------------------------- */
@keyframes thunk-collapse {
  0% {
    opacity: 1;
    transform: translate(0, 0) scale(1);
    stroke-dashoffset: 0; /* for lines */
  }
  100% {
    opacity: 0;
    transform: translate(
        calc(var(--collapse-x, 0px) - var(--node-x, 0px)),
        calc(var(--collapse-y, 0px) - var(--node-y, 0px))
      )
      scale(0);
    stroke-dashoffset: 100%; /* retract line */
  }
}

/* -----------------------------------------------------------------
 * Helper: expose node coordinates via CSS custom properties.
 * In practice these are set inline via JS when the graph is rendered.
 * Example:
 *   <g class="thunk-node" style="--node-x:120px; --node-y:80px;">
 * ----------------------------------------------------------------- */
.thunk-node {
  /* no default transform – animation will override */
}

/* -----------------------------------------------------------------
 * Connection line animation – use stroke-dasharray/dashoffset to
 * create a retract effect.
 * ----------------------------------------------------------------- */
.thunk-connection {
  stroke-dasharray: 1000; /* large enough to cover any line */
  stroke-dashoffset: 0;
}

/* When collapsing, the same keyframes apply, but we only need the
 * dashoffset change for lines. The transform part is harmless. */
.thunk-graph.thunk-collapsing .thunk-connection {
  animation-name: thunk-collapse;
}

/* ------------------------------------------------------------
 * Optional: set max depth automatically via JS.
 * ------------------------------------------------------------ */