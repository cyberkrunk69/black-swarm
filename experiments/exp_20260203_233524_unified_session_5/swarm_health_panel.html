<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swarm Health Panel</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
        .panel { display:flex; flex-wrap:wrap; gap:20px; max-width:1200px; margin:auto; }
        .gauge { background:#fff; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex:1 1 300px; }
        .gauge h3 { margin-top:0; font-size:1rem; color:#555; }
        .value { font-size:2rem; font-weight:bold; margin:10px 0; }
        .sparkline { width:100%; height:40px; }
        .progress { width:100%; height:20px; -webkit-appearance:none; appearance:none; }
        .progress::-webkit-progress-bar { background:#eee; border-radius:10px; }
        .progress::-webkit-progress-value { background:#4caf50; border-radius:10px; }
    </style>
</head>
<body>
    <h1>Swarm Health Panel</h1>
    <div class="panel">
        <div class="gauge" id="totalWorkers">
            <h3>Total Workers</h3>
            <div class="value" id="totalWorkersValue">–</div>
        </div>
        <div class="gauge" id="activeWorkers">
            <h3>Active Workers</h3>
            <div class="value" id="activeWorkersValue">–</div>
            <progress class="progress" id="activeWorkersProgress" max="100" value="0"></progress>
        </div>
        <div class="gauge" id="tasksPerMinute">
            <h3>Tasks / Minute</h3>
            <div class="value" id="tasksPerMinuteValue">–</div>
            <canvas class="sparkline" id="tasksSpark"></canvas>
        </div>
        <div class="gauge" id="costPerHour">
            <h3>Estimated Cost / Hour</h3>
            <div class="value" id="costPerHourValue">–</div>
        </div>
        <div class="gauge" id="apiErrorRate">
            <h3>API Error Rate</h3>
            <div class="value" id="apiErrorRateValue">–</div>
            <progress class="progress" id="apiErrorProgress" max="100" value="0"></progress>
        </div>
        <div class="gauge" id="checkpointFreshness">
            <h3>Checkpoint Freshness</h3>
            <div class="value" id="checkpointFreshnessValue">–</div>
            <progress class="progress" id="checkpointProgress" max="100" value="0"></progress>
        </div>
    </div>

    <script>
        // Simple sparkline using canvas
        class Sparkline {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = canvas.width = canvas.offsetWidth;
                this.height = canvas.height = canvas.offsetHeight;
                this.data = [];
                this.maxPoints = Math.floor(this.width / 2);
            }
            push(value) {
                this.data.push(value);
                if (this.data.length > this.maxPoints) this.data.shift();
                this.draw();
            }
            draw() {
                const ctx = this.ctx;
                ctx.clearRect(0,0,this.width,this.height);
                if (this.data.length < 2) return;
                const maxVal = Math.max(...this.data);
                const minVal = Math.min(...this.data);
                const range = maxVal - minVal || 1;
                ctx.strokeStyle = '#2196F3';
                ctx.lineWidth = 2;
                ctx.beginPath();
                this.data.forEach((v,i) => {
                    const x = (i / (this.maxPoints-1)) * this.width;
                    const y = this.height - ((v - minVal) / range) * this.height;
                    if (i===0) ctx.moveTo(x,y);
                    else ctx.lineTo(x,y);
                });
                ctx.stroke();
            }
        }

        const statsUrl = '/api/stats';
        const pollInterval = 5000; // ms

        const elements = {
            totalWorkers: document.getElementById('totalWorkersValue'),
            activeWorkers: document.getElementById('activeWorkersValue'),
            activeProgress: document.getElementById('activeWorkersProgress'),
            tasksPerMinute: document.getElementById('tasksPerMinuteValue'),
            tasksSpark: new Sparkline(document.getElementById('tasksSpark')),
            costPerHour: document.getElementById('costPerHourValue'),
            apiErrorRate: document.getElementById('apiErrorRateValue'),
            apiErrorProgress: document.getElementById('apiErrorProgress'),
            checkpointFreshness: document.getElementById('checkpointFreshnessValue'),
            checkpointProgress: document.getElementById('checkpointProgress')
        };

        function updateUI(data) {
            // Total workers (just a number)
            elements.totalWorkers.textContent = data.total_workers ?? '–';

            // Active workers (percentage of total)
            const active = data.active_workers ?? 0;
            const total = data.total_workers ?? 1;
            const activePct = Math.round((active/total)*100);
            elements.activeWorkers.textContent = `${active} / ${total}`;
            elements.activeProgress.value = activePct;

            // Tasks/minute sparkline
            const tpm = data.tasks_per_minute ?? 0;
            elements.tasksPerMinute.textContent = tpm;
            elements.tasksSpark.push(tpm);

            // Cost/hour
            elements.costPerHour.textContent = `$${(data.estimated_cost_per_hour ?? 0).toFixed(2)}`;

            // API error rate (percentage)
            const errRate = (data.api_error_rate ?? 0) * 100;
            elements.apiErrorRate.textContent = `${errRate.toFixed(2)}%`;
            elements.apiErrorProgress.value = Math.min(errRate,100);

            // Checkpoint freshness (seconds ago) – show as % of a 10‑minute window
            const freshnessSec = data.checkpoint_freshness_seconds ?? 0;
            const freshnessPct = Math.min((freshnessSec / 600) * 100, 100);
            elements.checkpointFreshness.textContent = `${freshnessSec}s ago`;
            elements.checkpointProgress.value = freshnessPct;
        }

        async function fetchStats() {
            try {
                const resp = await fetch(statsUrl);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                updateUI(data);
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        // Initial fetch + polling
        fetchStats();
        setInterval(fetchStats, pollInterval);
    </script>
</body>
</html>