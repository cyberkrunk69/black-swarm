<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unified Session Dashboard</title>
    <style>
        .node-card { border: 1px solid #ccc; border-radius: 6px; padding: 12px; margin: 8px; width: 300px; display: inline-block; vertical-align: top; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: #fff; }
        .badge.claude { background:#4A90E2; }
        .badge.groq   { background:#E94E77; }
        .summary { margin-top: 24px; }
        .chart { width: 400px; height: 250px; }
    </style>
</head>
<body>
    <h1>Session Dashboard</h1>

    <div id="nodes-container">
        <!-- Node cards will be injected here -->
    </div>

    <div class="summary">
        <h2>Usage Summary</h2>
        <div id="usage-split">Loading...</div>
        <canvas id="model-distribution" class="chart"></canvas>
    </div>

    <script>
        const eventSource = new EventSource('/sse/updates');

        // Keep a map of nodeId -> node data
        const nodes = {};

        function renderNode(node) {
            const container = document.getElementById('nodes-container');
            let card = document.getElementById(`node-${node.id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `node-${node.id}`;
                card.className = 'node-card';
                container.appendChild(card);
            }
            const engineBadge = node.engine === 'CLAUDE' ?
                `<span class="badge claude">CLAUDE</span>` :
                `<span class="badge groq">GROQ</span>`;

            card.innerHTML = `
                <h3>Node ${node.id}</h3>
                ${engineBadge}
                <p><strong>Model:</strong> ${node.model}</p>
                <p><strong>Reason:</strong> ${node.reason}</p>
                <p><strong>Tokens Used:</strong> ${node.tokens}</p>
                <p><strong>Cost Accrued:</strong> $${node.cost.toFixed(4)}</p>
            `;
        }

        function renderSummary(summary) {
            const splitDiv = document.getElementById('usage-split');
            splitDiv.innerHTML = `
                <p>Claude usage: ${summary.claude.percent}% (${summary.claude.tokens} tokens, $${summary.claude.cost.toFixed(4)})</p>
                <p>Groq usage: ${summary.groq.percent}% (${summary.groq.tokens} tokens, $${summary.groq.cost.toFixed(4)})</p>
            `;

            // Simple bar chart using Canvas (placeholder â€“ replace with Chart.js if available)
            const ctx = document.getElementById('model-distribution').getContext('2d');
            const labels = Object.keys(summary.models);
            const data = Object.values(summary.models).map(v => v.tokens);
            const max = Math.max(...data, 1);
            ctx.clearRect(0,0,400,250);
            ctx.fillStyle = '#4A90E2';
            labels.forEach((label,i) => {
                const barHeight = (data[i]/max)*200;
                ctx.fillRect(40 + i*60, 250-barHeight, 40, barHeight);
                ctx.fillStyle = '#000';
                ctx.fillText(label, 40 + i*60, 260);
                ctx.fillStyle = '#4A90E2';
            });
        }

        eventSource.onmessage = function(e) {
            const msg = JSON.parse(e.data);
            if (msg.type === 'node_update') {
                nodes[msg.node.id] = msg.node;
                renderNode(msg.node);
            } else if (msg.type === 'summary_update') {
                renderSummary(msg.summary);
            }
        };

        eventSource.onerror = function() {
            console.error('SSE connection error');
        };
    </script>
</body>
</html>