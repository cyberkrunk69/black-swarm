<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parallel Execution Timeline</title>
    <style>
        body { font-family: Arial, sans-serif; margin:0; overflow:hidden; }
        .axis line, .axis path { stroke: #888; }
        .task { stroke:#000; stroke-width:0.5px; }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color:#fff;
            padding:4px 8px;
            border-radius:4px;
            pointer-events:none;
            font-size:12px;
        }
    </style>
</head>
<body>
<div id="chart"></div>
<div class="tooltip" style="display:none;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// ---- Mock data ----------------------------------------------------
/*
   Each task: {
       id: string,
       start: Date,
       end: Date,
       worker: number,          // y‑axis slot
       origin: string           // file origin, used for colour
   }
*/
const tasks = [
    {id:"task_A", start:new Date("2026-02-04T08:00:00Z"), end:new Date("2026-02-04T08:15:00Z"), worker:1, origin:"file_a.py"},
    {id:"task_B", start:new Date("2026-02-04T08:05:00Z"), end:new Date("2026-02-04T08:20:00Z"), worker:2, origin:"file_b.py"},
    {id:"task_C", start:new Date("2026-02-04T08:12:00Z"), end:new Date("2026-02-04T08:30:00Z"), worker:1, origin:"file_a.py"},
    {id:"task_D", start:new Date("2026-02-04T08:18:00Z"), end:new Date("2026-02-04T08:45:00Z"), worker:3, origin:"file_c.py"},
    {id:"task_E", start:new Date("2026-02-04T08:25:00Z"), end:new Date("2026-02-04T08:55:00Z"), worker:2, origin:"file_b.py"},
    // add more rows as needed
];

// ---- Dimensions ---------------------------------------------------
const margin = {top: 20, right: 20, bottom: 30, left: 80};
const width = window.innerWidth - margin.left - margin.right;
const height = window.innerHeight - margin.top - margin.bottom;
const rowHeight = 30; // height per worker slot

// ---- Scales -------------------------------------------------------
const xExtent = d3.extent([...tasks.map(d=>d.start), ...tasks.map(d=>d.end)]);
const xScale = d3.scaleTime()
    .domain(xExtent)
    .range([0, width]);

const workers = Array.from(new Set(tasks.map(d=>d.worker))).sort((a,b)=>a-b);
const yScale = d3.scaleBand()
    .domain(workers)
    .range([0, workers.length * rowHeight])
    .paddingInner(0.1);

// colour by origin
const origins = Array.from(new Set(tasks.map(d=>d.origin)));
const colorScale = d3.scaleOrdinal()
    .domain(origins)
    .range(d3.schemeCategory10);

// ---- SVG container ------------------------------------------------
const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", workers.length * rowHeight + margin.top + margin.bottom)
    .call(d3.zoom()
        .scaleExtent([0.5, 10])
        .on("zoom", zoomed))
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// ---- Axes ---------------------------------------------------------
const xAxis = d3.axisBottom(xScale).ticks(10);
const yAxis = d3.axisLeft(yScale).tickFormat(d=>`Worker ${d}`);

svg.append("g")
    .attr("class","x axis")
    .attr("transform", `translate(0,${workers.length * rowHeight})`)
    .call(xAxis);

svg.append("g")
    .attr("class","y axis")
    .call(yAxis);

// ---- Tooltip -------------------------------------------------------
const tooltip = d3.select(".tooltip");

// ---- Draw tasks ----------------------------------------------------
const taskGroup = svg.append("g")
    .attr("class","tasks");

function draw() {
    const bars = taskGroup.selectAll(".task")
        .data(tasks, d=>d.id);

    // ENTER
    const barsEnter = bars.enter()
        .append("rect")
        .attr("class","task")
        .attr("rx",3).attr("ry",3)
        .attr("fill", d=>colorScale(d.origin))
        .on("mouseover", (event,d) => {
            tooltip.style("display","block")
                .html(`<strong>${d.id}</strong><br>
                       Origin: ${d.origin}<br>
                       Worker: ${d.worker}<br>
                       ${d.start.toISOString()} → ${d.end.toISOString()}`);
        })
        .on("mousemove", (event)=> {
            tooltip.style("left",(event.pageX+10)+"px")
                   .style("top",(event.pageY-28)+"px");
        })
        .on("mouseout",()=> tooltip.style("display","none"));

    // UPDATE + ENTER
    barsEnter.merge(bars)
        .attr("x", d=>xScale(d.start))
        .attr("y", d=>yScale(d.worker))
        .attr("width", d=>xScale(d.end)-xScale(d.start))
        .attr("height", yScale.bandwidth());

    // EXIT
    bars.exit().remove();
}
draw();

// ---- Zoom / Pan ----------------------------------------------------
function zoomed(event) {
    const transform = event.transform;
    const newXScale = transform.rescaleX(xScale);
    svg.select(".x.axis").call(xAxis.scale(newXScale));

    taskGroup.selectAll(".task")
        .attr("x", d=>newXScale(d.start))
        .attr("width", d=>newXScale(d.end)-newXScale(d.start));
}

// ---- Resize handling -----------------------------------------------
window.addEventListener("resize",()=> {
    const newWidth = window.innerWidth - margin.left - margin.right;
    const newHeight = window.innerHeight - margin.top - margin.bottom;
    d3.select("svg")
        .attr("width", newWidth + margin.left + margin.right)
        .attr("height", workers.length * rowHeight + margin.top + margin.bottom);
    xScale.range([0,newWidth]);
    svg.select(".x.axis")
        .attr("transform",`translate(0,${workers.length * rowHeight})`)
        .call(xAxis);
    draw();
});
</script>
</body>
</html>