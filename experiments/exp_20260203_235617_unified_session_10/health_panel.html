<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swarm Health Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; }
        .title { font-weight: bold; margin-bottom: 8px; }
        canvas { max-width: 100%; }
        .sparkline { height: 40px; }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Swarm Health Panel</h1>
    <div class="grid">
        <div class="card" id="total-workers-card">
            <div class="title">Total Workers</div>
            <canvas id="totalWorkersGauge"></canvas>
        </div>
        <div class="card" id="active-workers-card">
            <div class="title">Active Workers</div>
            <canvas id="activeWorkersGauge"></canvas>
        </div>
        <div class="card" id="throughput-card">
            <div class="title">Tasks / Minute</div>
            <canvas id="throughputSparkline" class="sparkline"></canvas>
        </div>
        <div class="card" id="cost-card">
            <div class="title">Estimated Cost / Hour</div>
            <canvas id="costGauge"></canvas>
        </div>
        <div class="card" id="error-rate-card">
            <div class="title">API Error Rate (%)</div>
            <canvas id="errorRateGauge"></canvas>
        </div>
        <div class="card" id="checkpoint-card">
            <div class="title">Checkpoint Freshness (min)</div>
            <canvas id="checkpointSparkline" class="sparkline"></canvas>
        </div>
    </div>

    <script>
        // Helper to create a simple gauge using Chart.js doughnut
        function createGauge(ctx, value, max, label, color) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, Math.max(max - value, 0)],
                        backgroundColor: [color, '#eaeaea'],
                        borderWidth: 0,
                        cutout: '80%'
                    }]
                },
                options: {
                    rotation: -90,
                    circumference: 180,
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `${value} ${label}`,
                            font: { size: 14 }
                        }
                    }
                }
            });
        }

        // Helper to create a sparkline (line chart)
        function createSparkline(ctx, data, color) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i + 1),
                    datasets: [{
                        data: data,
                        borderColor: color,
                        backgroundColor: 'rgba(0,0,0,0)',
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // State holders for sparkline data
        const throughputHistory = [];
        const checkpointHistory = [];

        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                if (!resp.ok) throw new Error('Network response was not ok');
                const stats = await resp.json();

                // Update gauges
                createGauge(document.getElementById('totalWorkersGauge'), stats.total_workers, stats.total_workers, 'workers', '#4caf50');
                createGauge(document.getElementById('activeWorkersGauge'), stats.active_workers, stats.total_workers, 'workers', '#2196f3');
                createGauge(document.getElementById('costGauge'), stats.estimated_cost_per_hour, 100, '$', '#ff9800');
                createGauge(document.getElementById('errorRateGauge'), stats.api_error_rate * 100, 100, '%', '#f44336');

                // Update sparkline histories (keep last 30 points)
                throughputHistory.push(stats.tasks_per_minute);
                if (throughputHistory.length > 30) throughputHistory.shift();
                checkpointHistory.push(stats.checkpoint_freshness_minutes);
                if (checkpointHistory.length > 30) checkpointHistory.shift();

                // Render sparklines
                createSparkline(document.getElementById('throughputSparkline'), throughputHistory, '#3f51b5');
                createSparkline(document.getElementById('checkpointSparkline'), checkpointHistory, '#009688');

            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        // Initial fetch + poll every 10 seconds
        fetchStats();
        setInterval(fetchStats, 10000);
    </script>
</body>
</html>