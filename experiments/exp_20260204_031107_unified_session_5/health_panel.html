<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
    .card { background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:15px; }
    canvas { max-width:100%; }
    .label { font-weight:bold; margin-top:10px; }
    .value { font-size:1.2em; }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card">
      <canvas id="totalWorkersGauge"></canvas>
      <div class="label">Total Workers</div>
    </div>
    <div class="card">
      <canvas id="activeWorkersGauge"></canvas>
      <div class="label">Active Workers</div>
    </div>
    <div class="card">
      <canvas id="tasksPerMinuteGauge"></canvas>
      <div class="label">Tasks / Minute</div>
    </div>
    <div class="card">
      <canvas id="costPerHourGauge"></canvas>
      <div class="label">Estimated Cost / Hour ($)</div>
    </div>
    <div class="card">
      <canvas id="apiErrorRateGauge"></canvas>
      <div class="label">API Error Rate (%)</div>
    </div>
    <div class="card">
      <canvas id="checkpointFreshnessGauge"></canvas>
      <div class="label">Checkpoint Freshness (min)</div>
    </div>
    <div class="card" style="grid-column: span 2;">
      <canvas id="throughputSparkline"></canvas>
      <div class="label">Tasks / Minute (last 5 min)</div>
    </div>
  </div>

  <script>
    // Helper to create a doughnut gauge
    function createGauge(ctx, maxValue, label) {
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [0, maxValue],
            backgroundColor: ['#4caf50', '#e0e0e0'],
            borderWidth: 0,
            cutout: '80%'
          }]
        },
        options: {
          rotation: -Math.PI,
          circumference: Math.PI,
          plugins: {
            tooltip: { enabled: false },
            legend: { display: false },
            title: {
              display: true,
              text: label,
              font: { size: 14 }
            }
          }
        }
      });
    }

    // Sparkline (line chart without axes)
    function createSparkline(ctx) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderColor: '#2196f3',
            backgroundColor: 'rgba(33,150,243,0.1)',
            tension: 0.3,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { display: false },
            y: { display: false }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          elements: { line: { borderWidth: 2 } }
        }
      });
    }

    const gauges = {
      totalWorkers: createGauge(document.getElementById('totalWorkersGauge'), 100, 'Total'),
      activeWorkers: createGauge(document.getElementById('activeWorkersGauge'), 100, 'Active'),
      tasksPerMinute: createGauge(document.getElementById('tasksPerMinuteGauge'), 200, 'TPS'),
      costPerHour: createGauge(document.getElementById('costPerHourGauge'), 500, 'Cost'),
      apiErrorRate: createGauge(document.getElementById('apiErrorRateGauge'), 100, 'Errors'),
      checkpointFreshness: createGauge(document.getElementById('checkpointFreshnessGauge'), 60, 'Freshness')
    };

    const sparkline = createSparkline(document.getElementById('throughputSparkline'));

    const throughputHistory = [];

    async function fetchStats() {
      try {
        const resp = await fetch('/api/stats');
        if (!resp.ok) throw new Error('Network response was not ok');
        const data = await resp.json();

        // Update gauges
        function updateGauge(gauge, value, max) {
          gauge.data.datasets[0].data[0] = Math.min(value, max);
          gauge.data.datasets[0].data[1] = Math.max(max - value, 0);
          gauge.update();
        }

        updateGauge(gauges.totalWorkers, data.total_workers, 200);
        updateGauge(gauges.activeWorkers, data.active_workers, data.total_workers || 200);
        updateGauge(gauges.tasksPerMinute, data.tasks_per_minute, 200);
        updateGauge(gauges.costPerHour, data.cost_per_hour, 500);
        updateGauge(gauges.apiErrorRate, data.api_error_rate * 100, 100);
        const freshnessMin = (Date.now() - new Date(data.checkpoint_timestamp).getTime()) / 60000;
        updateGauge(gauges.checkpointFreshness, freshnessMin, 60);

        // Update sparkline
        const now = new Date();
        throughputHistory.push({ t: now, v: data.tasks_per_minute });
        // keep last 5 minutes (assuming poll every 5s)
        const cutoff = new Date(now.getTime() - 5 * 60 * 1000);
        while (throughputHistory.length && throughputHistory[0].t < cutoff) {
          throughputHistory.shift();
        }
        sparkline.data.labels = throughputHistory.map(p => '');
        sparkline.data.datasets[0].data = throughputHistory.map(p => p.v);
        sparkline.update();

      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Initial fetch and polling
    fetchStats();
    setInterval(fetchStats, 5000);
  </script>
</body>
</html>