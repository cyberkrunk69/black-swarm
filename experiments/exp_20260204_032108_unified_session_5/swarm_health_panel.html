<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swarm Health Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; text-align: center; }
        .title { font-size: 1.1rem; margin-bottom: 8px; color: #555; }
        .value { font-size: 2rem; font-weight: bold; }
        .sparkline { width: 100%; height: 50px; }
    </style>
    <!-- Simple sparkline library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sparkline/0.1.2/sparkline.min.js"></script>
</head>
<body>
    <h1>Swarm Health Panel</h1>
    <div class="grid">
        <div class="card" id="total-workers-card">
            <div class="title">Total Workers</div>
            <div class="value" id="total-workers">-</div>
        </div>
        <div class="card" id="active-workers-card">
            <div class="title">Active Workers</div>
            <div class="value" id="active-workers">-</div>
        </div>
        <div class="card" id="throughput-card">
            <div class="title">Tasks / Minute</div>
            <canvas id="throughput-sparkline" class="sparkline"></canvas>
        </div>
        <div class="card" id="cost-card">
            <div class="title">Estimated Cost / Hour</div>
            <div class="value" id="cost-per-hour">-</div>
        </div>
        <div class="card" id="error-rate-card">
            <div class="title">API Error Rate</div>
            <canvas id="error-rate-sparkline" class="sparkline"></canvas>
        </div>
        <div class="card" id="checkpoint-card">
            <div class="title">Checkpoint Freshness (min)</div>
            <canvas id="checkpoint-sparkline" class="sparkline"></canvas>
        </div>
    </div>

    <script>
        const POLL_INTERVAL_MS = 10000; // 10 seconds
        const historyLength = 30; // keep 30 data points for sparklines

        const dataHistory = {
            throughput: [],
            errorRate: [],
            checkpointFreshness: []
        };

        function renderSparkline(canvasId, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            Sparkline.draw(ctx, data, { lineColor: '#007bff', fillColor: 'rgba(0,123,255,0.2)' });
        }

        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                if (!resp.ok) throw new Error('Network response was not ok');
                const stats = await resp.json();

                // Update simple values
                document.getElementById('total-workers').textContent = stats.total_workers ?? '-';
                document.getElementById('active-workers').textContent = stats.active_workers ?? '-';
                document.getElementById('cost-per-hour').textContent = stats.estimated_cost_per_hour?.toFixed(2) ?? '-';

                // Update histories
                const now = Date.now();
                // Throughput (tasks/min)
                const tp = stats.tasks_per_minute ?? 0;
                dataHistory.throughput.push(tp);
                if (dataHistory.throughput.length > historyLength) dataHistory.throughput.shift();

                // Error rate (percentage)
                const er = stats.api_error_rate_percent ?? 0;
                dataHistory.errorRate.push(er);
                if (dataHistory.errorRate.length > historyLength) dataHistory.errorRate.shift();

                // Checkpoint freshness (minutes)
                const cf = stats.checkpoint_freshness_minutes ?? 0;
                dataHistory.checkpointFreshness.push(cf);
                if (dataHistory.checkpointFreshness.length > historyLength) dataHistory.checkpointFreshness.shift();

                // Render sparklines
                renderSparkline('throughput-sparkline', dataHistory.throughput);
                renderSparkline('error-rate-sparkline', dataHistory.errorRate);
                renderSparkline('checkpoint-sparkline', dataHistory.checkpointFreshness);
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        // Initial fetch + polling
        fetchStats();
        setInterval(fetchStats, POLL_INTERVAL_MS);
    </script>
</body>
</html>