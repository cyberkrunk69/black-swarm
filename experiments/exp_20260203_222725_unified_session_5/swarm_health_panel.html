<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swarm Health Panel</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px;}
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; }
        .card { background:#fff; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,.1); padding:20px; text-align:center;}
        .title { font-size:14px; color:#555; margin-bottom:8px;}
        .value { font-size:28px; font-weight:bold; }
        canvas { max-width:100%; }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Gauge plugin (simple gauge via doughnut) -->
</head>
<body>
    <h1>Swarm Health Panel</h1>
    <div class="grid">
        <div class="card" id="total-workers-card">
            <div class="title">Total Workers</div>
            <canvas id="totalWorkersGauge"></canvas>
        </div>
        <div class="card" id="active-workers-card">
            <div class="title">Active Workers</div>
            <canvas id="activeWorkersGauge"></canvas>
        </div>
        <div class="card" id="throughput-card">
            <div class="title">Tasks / Minute</div>
            <canvas id="throughputSparkline"></canvas>
        </div>
        <div class="card" id="cost-card">
            <div class="title">Estimated Cost / Hour</div>
            <canvas id="costGauge"></canvas>
        </div>
        <div class="card" id="error-rate-card">
            <div class="title">API Error Rate (%)</div>
            <canvas id="errorRateGauge"></canvas>
        </div>
        <div class="card" id="checkpoint-card">
            <div class="title">Checkpoint Freshness (min ago)</div>
            <canvas id="checkpointGauge"></canvas>
        </div>
    </div>

    <script>
        // Helper to create a simple gauge using a doughnut chart
        function createGauge(ctx, max, label) {
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, max],
                        backgroundColor: ['#4caf50', '#e0e0e0'],
                        borderWidth: 0,
                    }],
                    labels: [label, '']
                },
                options: {
                    rotation: -Math.PI,
                    circumference: Math.PI,
                    cutout: '80%',
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '0',
                            font: { size: 24 }
                        }
                    }
                }
            });
        }

        // Sparkline for throughput (line chart)
        function createSparkline(ctx) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // timestamps
                    datasets: [{
                        label: 'Tasks/min',
                        data: [],
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33,150,243,0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    },
                    plugins: { legend: { display: false } },
                    elements: { line: { borderWidth: 2 } },
                    animation: false,
                    maintainAspectRatio: false,
                }
            });
        }

        const gauges = {
            totalWorkers: createGauge(document.getElementById('totalWorkersGauge').getContext('2d'), 100, 'Workers'),
            activeWorkers: createGauge(document.getElementById('activeWorkersGauge').getContext('2d'), 100, 'Active'),
            cost: createGauge(document.getElementById('costGauge').getContext('2d'), 1000, '$/hr'),
            errorRate: createGauge(document.getElementById('errorRateGauge').getContext('2d'), 100, 'Error %'),
            checkpoint: createGauge(document.getElementById('checkpointGauge').getContext('2d'), 60, 'min ago')
        };

        const throughputChart = createSparkline(document.getElementById('throughputSparkline').getContext('2d'));

        // Update gauge visual
        function updateGauge(gauge, value, max) {
            gauge.data.datasets[0].data = [value, max - value];
            gauge.options.plugins.title.text = value.toString();
            gauge.update();
        }

        // Polling function
        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                if (!resp.ok) throw new Error('Network response was not ok');
                const data = await resp.json();

                // Expected data shape:
                // {
                //   total_workers: number,
                //   active_workers: number,
                //   tasks_per_minute: number,
                //   estimated_cost_per_hour: number,
                //   api_error_rate: number (percentage),
                //   checkpoint_freshness_minutes: number
                // }

                updateGauge(gauges.totalWorkers, data.total_workers, Math.max(100, data.total_workers));
                updateGauge(gauges.activeWorkers, data.active_workers, Math.max(100, data.total_workers));
                updateGauge(gauges.cost, data.estimated_cost_per_hour, Math.max(1000, data.estimated_cost_per_hour));
                updateGauge(gauges.errorRate, data.api_error_rate, 100);
                updateGauge(gauges.checkpoint, data.checkpoint_freshness_minutes, 60);

                // Update throughput sparkline
                const now = new Date().toLocaleTimeString();
                throughputChart.data.labels.push(now);
                throughputChart.data.datasets[0].data.push(data.tasks_per_minute);
                if (throughputChart.data.labels.length > 30) {
                    throughputChart.data.labels.shift();
                    throughputChart.data.datasets[0].data.shift();
                }
                throughputChart.update();

            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        // Initial fetch and interval
        fetchStats();
        setInterval(fetchStats, 5000); // every 5 seconds
    </script>
</body>
</html>