<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swarm Health Panel</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
        .panel { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
        .card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,.1); }
        .card h3 { margin-top:0; font-size:1rem; color:#555; }
        .gauge { width:150px; height:150px; margin:auto; }
        .sparkline { width:100%; height:50px; }
        .value { font-size:1.5rem; text-align:center; margin-top:10px; }
    </style>
    <!-- Chart.js for sparklines -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- JustGage for gauges -->
    <script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
</head>
<body>
    <h1>Swarm Health Panel</h1>
    <div class="panel">
        <div class="card" id="total-workers-card">
            <h3>Total Workers</h3>
            <div id="total-workers-gauge" class="gauge"></div>
        </div>
        <div class="card" id="active-workers-card">
            <h3>Active Workers</h3>
            <div id="active-workers-gauge" class="gauge"></div>
        </div>
        <div class="card" id="throughput-card">
            <h3>Tasks / Minute</h3>
            <canvas id="throughput-sparkline" class="sparkline"></canvas>
            <div class="value" id="throughput-value">-</div>
        </div>
        <div class="card" id="cost-card">
            <h3>Estimated Cost / Hour</h3>
            <canvas id="cost-sparkline" class="sparkline"></canvas>
            <div class="value" id="cost-value">-</div>
        </div>
        <div class="card" id="error-rate-card">
            <h3>API Error Rate (%)</h3>
            <div id="error-rate-gauge" class="gauge"></div>
        </div>
        <div class="card" id="checkpoint-card">
            <h3>Checkpoint Freshness</h3>
            <canvas id="checkpoint-sparkline" class="sparkline"></canvas>
            <div class="value" id="checkpoint-value">-</div>
        </div>
    </div>

    <script>
        // Global gauge objects
        const gauges = {};

        // Sparkline chart instances
        const sparkCharts = {};

        // Historical buffers for sparklines (last 30 samples)
        const history = {
            throughput: [],
            cost: [],
            checkpoint: []
        };

        function createGauge(id, max, title) {
            gauges[id] = new JustGage({
                id: id,
                value: 0,
                min: 0,
                max: max,
                title: title,
                gaugeWidthScale: 0.6,
                counter: true,
                hideInnerShadow: true
            });
        }

        function createSparkline(ctx, label) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: label,
                        data: [],
                        borderColor: '#3e95cd',
                        fill: false,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        }

        // Initialize gauges
        createGauge('total-workers-gauge', 1000, 'Workers');
        createGauge('active-workers-gauge', 1000, 'Active');
        createGauge('error-rate-gauge', 100, 'Error %');

        // Initialize sparklines
        sparkCharts.throughput = createSparkline(document.getElementById('throughput-sparkline'), 'Throughput');
        sparkCharts.cost = createSparkline(document.getElementById('cost-sparkline'), 'Cost');
        sparkCharts.checkpoint = createSparkline(document.getElementById('checkpoint-sparkline'), 'Freshness');

        async function fetchStats() {
            try {
                const resp = await fetch('/api/stats');
                if (!resp.ok) throw new Error('Network response was not ok');
                const data = await resp.json();

                // Update gauges
                gauges['total-workers-gauge'].refresh(data.total_workers);
                gauges['active-workers-gauge'].refresh(data.active_workers);
                gauges['error-rate-gauge'].refresh(data.api_error_rate * 100); // assuming rate as fraction

                // Update throughput
                document.getElementById('throughput-value').textContent = data.tasks_per_minute.toFixed(1);
                updateSparkline('throughput', data.tasks_per_minute);

                // Update cost
                document.getElementById('cost-value').textContent = `$${data.estimated_cost_per_hour.toFixed(2)}`;
                updateSparkline('cost', data.estimated_cost_per_hour);

                // Update checkpoint freshness (seconds since last checkpoint)
                const now = Date.now();
                const freshnessSec = (now - new Date(data.checkpoint_freshness).getTime()) / 1000;
                document.getElementById('checkpoint-value').textContent = `${freshnessSec.toFixed(0)}s ago`;
                updateSparkline('checkpoint', freshnessSec);
            } catch (e) {
                console.error('Failed to fetch stats:', e);
            }
        }

        function updateSparkline(key, value) {
            const buffer = history[key];
            buffer.push(value);
            if (buffer.length > 30) buffer.shift();

            const chart = sparkCharts[key];
            chart.data.labels = buffer.map((_, i) => i);
            chart.data.datasets[0].data = buffer;
            chart.update('none');
        }

        // Poll every 5 seconds
        fetchStats();
        setInterval(fetchStats, 5000);
    </script>
</body>
</html>