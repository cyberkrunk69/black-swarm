<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .card { background:#fff; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .title { font-size:0.9rem; color:#555; margin-bottom:5px; }
    .value { font-size:1.8rem; font-weight:bold; }
    canvas { width:100% !important; height:auto !important; }
  </style>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card">
      <div class="title">Total Workers</div>
      <div class="value" id="totalWorkers">‑</div>
    </div>
    <div class="card">
      <div class="title">Active Workers</div>
      <div class="value" id="activeWorkers">‑</div>
    </div>
    <div class="card">
      <div class="title">Tasks / Minute</div>
      <canvas id="tasksGauge"></canvas>
    </div>
    <div class="card">
      <div class="title">Estimated Cost / Hour</div>
      <canvas id="costGauge"></canvas>
    </div>
    <div class="card">
      <div class="title">API Error Rate</div>
      <canvas id="errorGauge"></canvas>
    </div>
    <div class="card">
      <div class="title">Checkpoint Freshness (min)</div>
      <canvas id="freshnessGauge"></canvas>
    </div>
  </div>

  <!-- Simple gauge implementation using Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const gaugeConfig = (label, max) => ({
      type: 'doughnut',
      data: {
        labels: [label, ''],
        datasets: [{
          data: [0, max],
          backgroundColor: ['#4caf50', '#e0e0e0'],
          borderWidth: 0,
        }]
      },
      options: {
        rotation: -Math.PI,
        circumference: Math.PI,
        cutout: '80%',
        plugins: {
          tooltip: { enabled: false },
          legend: { display: false },
          datalabels: { display: false }
        }
      }
    });

    const charts = {
      tasks: new Chart(document.getElementById('tasksGauge'), gaugeConfig('Tasks/min', 200)),
      cost: new Chart(document.getElementById('costGauge'), gaugeConfig('Cost/$h', 100)),
      error: new Chart(document.getElementById('errorGauge'), gaugeConfig('Error %', 100)),
      freshness: new Chart(document.getElementById('freshnessGauge'), gaugeConfig('Freshness (min)', 60))
    };

    function updateGauge(chart, value, max) {
      chart.data.datasets[0].data = [value, Math.max(max - value, 0)];
      chart.update();
    }

    async function fetchStats() {
      try {
        const resp = await fetch('/api/stats');
        if (!resp.ok) throw new Error('Network response was not ok');
        const data = await resp.json();

        // Expected keys: total_workers, active_workers, tasks_per_minute,
        // estimated_cost_per_hour, api_error_rate, checkpoint_freshness_min
        document.getElementById('totalWorkers').textContent = data.total_workers ?? '‑';
        document.getElementById('activeWorkers').textContent = data.active_workers ?? '‑';

        updateGauge(charts.tasks, data.tasks_per_minute ?? 0, 200);
        updateGauge(charts.cost, data.estimated_cost_per_hour ?? 0, 100);
        updateGauge(charts.error, data.api_error_rate ?? 0, 100);
        updateGauge(charts.freshness, data.checkpoint_freshness_min ?? 0, 60);
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Initial fetch and poll every 5 seconds
    fetchStats();
    setInterval(fetchStats, 5000);
  </script>
</body>
</html>