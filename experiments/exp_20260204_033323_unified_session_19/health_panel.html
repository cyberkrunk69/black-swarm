<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swarm Health Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background:#f5f5f5; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    .title { font-size:0.9rem; color:#555; margin-bottom:5px; }
    .value { font-size:1.8rem; font-weight:bold; }
    canvas { width:100% !important; height:auto !important; }
  </style>
  <!-- CDN libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/justgage@1.4.0/justgage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
</head>
<body>
  <h1>Swarm Health Panel</h1>
  <div class="grid">
    <div class="card">
      <div class="title">Total Workers</div>
      <div id="totalWorkersGauge" class="value">—</div>
    </div>
    <div class="card">
      <div class="title">Active Workers</div>
      <div id="activeWorkersGauge" class="value">—</div>
    </div>
    <div class="card">
      <div class="title">Tasks / Minute</div>
      <canvas id="tasksChart"></canvas>
    </div>
    <div class="card">
      <div class="title">Estimated Cost / Hour</div>
      <div id="costGauge" class="value">—</div>
    </div>
    <div class="card">
      <div class="title">API Error Rate (%)</div>
      <div id="errorRateGauge" class="value">—</div>
    </div>
    <div class="card">
      <div class="title">Checkpoint Freshness (min)</div>
      <canvas id="checkpointChart"></canvas>
    </div>
  </div>

  <script>
    // Simple gauge using JustGage (numeric display)
    function createGauge(id, max) {
      return new JustGage({
        id: id,
        value: 0,
        min: 0,
        max: max,
        title: '',
        gaugeWidthScale: 0.6,
        hideMinMax: true,
        hideValue: false,
        valueFontColor: '#333',
        gaugeColor: '#6EA8FE',
        levelColors: ['#ff0000', '#f9c802', '#a9d70b']
      });
    }

    const totalWorkersGauge = createGauge('totalWorkersGauge', 100);
    const activeWorkersGauge = createGauge('activeWorkersGauge', 100);
    const costGauge = createGauge('costGauge', 500); // arbitrary max cost
    const errorRateGauge = createGauge('errorRateGauge', 100);

    // Chart.js sparkline configs
    const tasksCtx = document.getElementById('tasksChart').getContext('2d');
    const checkpointCtx = document.getElementById('checkpointChart').getContext('2d');

    const tasksChart = new Chart(tasksCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Tasks/min', data: [], borderColor: '#42a5f5', fill: false, tension: 0.3 }]},
      options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false } } }
    });

    const checkpointChart = new Chart(checkpointCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Freshness (min)', data: [], borderColor: '#66bb6a', fill: false, tension: 0.3 }]},
      options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { display: false } }, plugins: { legend: { display: false } } }
    });

    // Helper to keep rolling data (last N points)
    const MAX_POINTS = 30;
    function pushData(chart, value) {
      if (chart.data.labels.length >= MAX_POINTS) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      const now = new Date();
      chart.data.labels.push(now.toLocaleTimeString());
      chart.data.datasets[0].data.push(value);
      chart.update('quiet');
    }

    async function fetchStats() {
      try {
        const resp = await fetch('/api/stats');
        if (!resp.ok) throw new Error('Network response was not ok');
        const data = await resp.json();

        // Expected keys: total_workers, active_workers, tasks_per_minute, estimated_cost_per_hour,
        // api_error_rate (0-1), checkpoint_freshness_min
        totalWorkersGauge.refresh(data.total_workers);
        activeWorkersGauge.refresh(data.active_workers);
        costGauge.refresh(data.estimated_cost_per_hour);
        errorRateGauge.refresh((data.api_error_rate || 0) * 100);

        pushData(tasksChart, data.tasks_per_minute);
        pushData(checkpointChart, data.checkpoint_freshness_min);
      } catch (e) {
        console.error('Failed to fetch stats:', e);
      }
    }

    // Initial load + polling
    fetchStats();
    setInterval(fetchStats, 5000); // poll every 5 seconds
  </script>
</body>
</html>