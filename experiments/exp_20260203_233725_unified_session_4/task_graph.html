<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Dependency Graph</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        #graph { width: 100vw; height: 100vh; }
        .node.completed rect { fill: #8bc34a; }               /* green */
        .node.in-progress rect { stroke: #ff5722; stroke-width: 4px; fill: #fff3e0; } /* rainbow border approximated */
        .node.blocked rect { fill: #9e9e9e; }                /* gray */
        .node text { pointer-events: none; font-size: 12px; }
    </style>
    <!-- D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- dagre-d3 for automatic layout -->
    <script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>
</head>
<body>
    <svg id="graph"></svg>

    <script>
        // --------------------------------------------------------------------
        // Configuration: list all grind_tasks_*.json files you want to visualise.
        // --------------------------------------------------------------------
        const jsonFiles = [
            // Example:
            // "grind_tasks_phase1.json",
            // "grind_tasks_phase2.json",
        ];

        // --------------------------------------------------------------------
        // Helper: determine node status class based on task properties.
        // --------------------------------------------------------------------
        function statusClass(task) {
            if (task.completed) return "completed";
            if (task.in_progress) return "in-progress";
            // If not completed and not in progress, treat as blocked.
            return "blocked";
        }

        // --------------------------------------------------------------------
        // Main: load JSON files, build graph, render.
        // --------------------------------------------------------------------
        async function loadAll() {
            const allTasks = [];
            for (const file of jsonFiles) {
                const resp = await fetch(file);
                if (!resp.ok) {
                    console.warn(`Could not load ${file}: ${resp.status}`);
                    continue;
                }
                const data = await resp.json();
                // Expect each file to be an array of task objects:
                // { id: "task_1", name: "Do X", phase: "phase1", deps: ["task_0"], completed: true, in_progress: false }
                allTasks.push(...data);
            }
            renderGraph(allTasks);
        }

        function renderGraph(tasks) {
            const g = new dagre.graphlib.Graph({ multigraph: true })
                .setGraph({ rankdir: "LR", marginx: 20, marginy: 20 })
                .setDefaultEdgeLabel(() => ({}));

            // Add nodes
            tasks.forEach(task => {
                const label = `${task.name}\\n(${task.phase})`;
                g.setNode(task.id, {
                    label: label,
                    class: `node ${statusClass(task)}`,
                    shape: "rect",
                    style: "stroke: #333; stroke-width: 1px;"
                });
            });

            // Add edges (dependencies)
            tasks.forEach(task => {
                if (Array.isArray(task.deps)) {
                    task.deps.forEach(dep => {
                        if (g.hasNode(dep) && g.hasNode(task.id)) {
                            g.setEdge(dep, task.id);
                        }
                    });
                }
            });

            // Render
            const render = new dagre.render();
            const svg = d3.select("#graph");
            const inner = svg.append("g");

            // Apply zoom/pan
            const zoom = d3.zoom().on("zoom", (event) => inner.attr("transform", event.transform));
            svg.call(zoom);

            render(inner, g);

            // Apply custom CSS classes
            inner.selectAll("g.node")
                .attr("class", d => g.node(d).class);

            // Resize SVG to fit content
            const { width, height } = inner.node().getBBox();
            svg.attr("viewBox", `0 0 ${width + 40} ${height + 40}`);
        }

        // Kick off
        if (jsonFiles.length === 0) {
            document.body.innerHTML = "<p style='margin:20px;color:red;'>No JSON files configured. Edit the <code>jsonFiles</code> array in this script.</p>";
        } else {
            loadAll().catch(err => console.error(err));
        }
    </script>
</body>
</html>